<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Debates - Diplomaq.lol</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" />
  <script src="https://js.pusher.com/7.0/pusher.min.js"></script>
  <style>
    :root {
      --primary: #1f1d79;
      --primary-light: #a5bcda;
      --secondary: #ff6309;
      --secondary-light: #ff7c30;
      --accent: #c75495;
      --bg-cream: #fdfbf6;
      --text-dark: #454545;
    }
    
    body {
      font-family: 'Outfit', sans-serif;
      background-color: #f0f4fc;
      color: var(--text-dark);
      overflow-x: hidden;
    }
    
    .gradient-bg {
      background: linear-gradient(135deg, #1f1d79 0%, #005791 100%);
    }
    
    .gradient-text {
      background: linear-gradient(90deg, #1f1d79 0%, #c75495 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    .gradient-button {
      background: linear-gradient(90deg, #ff6309 0%, #ff7c30 100%);
      transition: all 0.3s ease;
    }
    
    .gradient-button:hover {
      background: linear-gradient(90deg, #e86a00 0%, #f16a30 100%);
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(255, 99, 9, 0.2);
    }
    
    .glass-nav {
      background-color: rgba(255, 255, 255, 0.8);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }
    
    .debate-card {
      transition: all 0.3s ease;
    }
    
    .debate-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
    }
    
    .chat-container {
      height: 400px;
      overflow-y: auto;
    }
    
    .chat-message {
      margin-bottom: 12px;
      padding: 10px 15px;
      border-radius: 18px;
      max-width: 80%;
      word-wrap: break-word;
    }
    
    .chat-message.user {
      background-color: #e6f2ff;
      margin-left: auto;
      border-bottom-right-radius: 4px;
    }
    
    .chat-message.other {
      background-color: #f0f0f0;
      margin-right: auto;
      border-bottom-left-radius: 4px;
    }
    
    .chat-message.ai {
      background-color: #f0e6ff;
      margin-right: auto;
      border-bottom-left-radius: 4px;
      border-left: 3px solid #9966cc;
    }
    
    /* Modal styles */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }
    
    .modal.active {
      display: flex;
    }
    
    .modal-content {
      background-color: white;
      padding: 30px;
      border-radius: 12px;
      width: 90%;
      max-width: 600px;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
      animation: modalFadeIn 0.3s;
    }
    
    @keyframes modalFadeIn {
      from { opacity: 0; transform: translateY(-20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    /* Loading spinner */
    .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid rgba(0, 0, 0, 0.1);
      border-radius: 50%;
      border-top-color: var(--primary);
      animation: spin 1s ease-in-out infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    /* Tabs */
    .tab {
      cursor: pointer;
      padding: 10px 20px;
      border-bottom: 2px solid transparent;
      transition: all 0.3s ease;
    }
    
    .tab.active {
      border-bottom: 2px solid var(--primary);
      color: var(--primary);
      font-weight: 600;
    }
    
    .tab-content {
      display: none;
    }
    
    .tab-content.active {
      display: block;
    }
  </style>
</head>
<body>
  <!-- Navigation -->
  <nav class="glass-nav shadow-md sticky top-0 z-50 transition-all duration-300">
    <div class="container mx-auto px-4 py-3">
      <div class="flex justify-between items-center">
        <div class="flex items-center space-x-2">
          <a href="index.html" class="flex items-center">
            <div class="relative">
              <svg width="48" height="48" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg" class="animate__animated animate__fadeIn">
                <circle cx="24" cy="24" r="18" fill="#1f1d79"/>
                <path d="M24 6C14.0589 6 6 14.0589 6 24C6 33.9411 14.0589 42 24 42C33.9411 42 42 33.9411 42 24C42 14.0589 33.9411 6 24 6Z" fill="#1f1d79"/>
                <path d="M18 18C18 16.0117 19.6117 14.4 21.6 14.4H26.4C28.3883 14.4 30 16.0117 30 18V30C30 31.9883 28.3883 33.6 26.4 33.6H21.6C19.6117 33.6 18 31.9883 18 30V18Z" fill="white"/>
                <path d="M14.4 21.6C14.4 20.2745 15.4745 19.2 16.8 19.2C18.1255 19.2 19.2 20.2745 19.2 21.6V26.4C19.2 27.7255 18.1255 28.8 16.8 28.8C15.4745 28.8 14.4 27.7255 14.4 26.4V21.6Z" fill="white"/>
                <path d="M28.8 21.6C28.8 20.2745 29.8745 19.2 31.2 19.2C32.5255 19.2 33.6 20.2745 33.6 21.6V26.4C33.6 27.7255 32.5255 28.8 31.2 28.8C29.8745 28.8 28.8 27.7255 28.8 26.4V21.6Z" fill="white"/>
                <path d="M34 34L38 38M38 34L34 38" stroke="white" stroke-width="1.5" stroke-linecap="round"/>
              </svg>
              <div class="absolute -bottom-1 -right-1 text-xs font-bold text-[#ff6309]">.lol</div>
            </div>
            <h1 class="text-2xl font-bold text-[#1f1d79] animate__animated animate__fadeIn">Diplomaq</h1>
          </a>
        </div>
        <div class="hidden md:flex space-x-6">
          <a href="index.html" class="text-gray-600 hover:text-[#1f1d79] transition">Home</a>
          <a href="debates.html" class="text-[#1f1d79] font-medium transition">Debates</a>
          <a href="profile.html" class="text-gray-600 hover:text-[#1f1d79] transition">Profile</a>
        </div>
        <div>
          <!-- User is signed in -->
          <div id="user-signed-in" class="hidden">
            <div class="flex items-center space-x-4">
              <div class="flex items-center space-x-2">
                <img id="user-avatar" src="/placeholder.svg" alt="User Avatar" class="w-8 h-8 rounded-full">
                <span id="user-name" class="text-sm font-medium hidden md:inline"></span>
              </div>
              <div class="flex space-x-2">
                <a href="profile.html" class="px-3 py-1.5 text-sm border border-[#1f1d79] text-[#1f1d79] font-medium rounded-md hover:bg-[#1f1d79] hover:text-white transition">Profile</a>
                <a href="#" id="logout-btn" class="px-3 py-1.5 text-sm border border-[#1f1d79] text-[#1f1d79] font-medium rounded-md hover:bg-[#1f1d79] hover:text-white transition">Sign Out</a>
              </div>
            </div>
          </div>
          
          <!-- User is not signed in -->
          <div id="user-not-signed-in">
            <a href="signin.html" class="px-4 py-2 border-2 border-[#1f1d79] text-[#1f1d79] font-medium rounded-md hover:bg-[#1f1d79] hover:text-white transition">Sign In</a>
          </div>
        </div>
        <!-- Mobile menu button -->
        <div class="md:hidden">
          <button id="mobile-menu-button" class="p-2 rounded-md text-gray-600 hover:text-[#1f1d79] hover:bg-gray-100 transition">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
            </svg>
          </button>
        </div>
      </div>
    </div>
  </nav>
  
  <!-- Mobile menu -->
  <div id="mobile-menu" class="hidden md:hidden bg-white shadow-lg rounded-b-lg animate__animated animate__fadeIn">
    <div class="px-4 py-3 space-y-2">
      <a href="index.html" class="block px-3 py-2 rounded-md text-gray-700 hover:bg-gray-100 hover:text-[#1f1d79] transition">Home</a>
      <a href="debates.html" class="block px-3 py-2 rounded-md text-[#1f1d79] font-medium bg-gray-100 transition">Debates</a>
      <a href="profile.html" class="block px-3 py-2 rounded-md text-gray-700 hover:bg-gray-100 hover:text-[#1f1d79] transition">Profile</a>
    </div>
  </div>
  
  <!-- Main Content -->
  <main class="container mx-auto px-4 py-8">
    <!-- Header -->
    <div class="mb-8">
      <h1 class="text-3xl font-bold text-[#1f1d79] mb-2">UN Debates</h1>
      <p class="text-gray-600">Join or create debates on global issues and practice your diplomatic skills</p>
    </div>
    
    <!-- Filter Section -->
    <div class="bg-white rounded-xl shadow-md p-6 mb-8">
      <div class="flex flex-col md:flex-row gap-4">
        <div class="flex-1">
          <label for="topic-filter" class="block text-sm font-medium text-gray-700 mb-1">Filter by Topic</label>
          <input type="text" id="topic-filter" placeholder="Search topics..." class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-[#1f1d79]">
        </div>
        <div>
          <label for="status-filter" class="block text-sm font-medium text-gray-700 mb-1">Status</label>
          <select id="status-filter" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-[#1f1d79]">
            <option value="all">All Debates</option>
            <option value="active" selected>Active</option>
            <option value="scheduled">Scheduled</option>
          </select>
        </div>
        <div class="self-end">
          <button id="apply-filters-btn" class="px-6 py-2 gradient-button text-white font-semibold rounded-md">Apply Filters</button>
        </div>
      </div>
    </div>
    
    <!-- Auth Check -->
    <div id="auth-check" class="bg-white rounded-xl shadow-md p-8 text-center mb-8 hidden">
      <h2 class="text-2xl font-bold text-[#1f1d79] mb-4">Sign In to Join Debates</h2>
      <p class="text-gray-600 mb-6">You need to sign in to join debates and participate in discussions.</p>
      <a href="signin.html" class="px-6 py-3 gradient-button text-white font-semibold rounded-md">Sign In</a>
    </div>
    
    <!-- Debates List -->
    <div id="debates-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
      <!-- Debates will be loaded here -->
      <div class="flex justify-center items-center col-span-full py-12">
        <div class="spinner"></div>
      </div>
    </div>
    
    <!-- Create Debate Button -->
    <div class="fixed bottom-6 right-6">
      <button id="create-debate-btn" class="gradient-button text-white font-semibold rounded-full w-14 h-14 flex items-center justify-center shadow-lg hover:shadow-xl">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
        </svg>
      </button>
    </div>
  </main>
  
  <!-- Create Debate Modal -->
  <div id="create-debate-modal" class="modal">
    <div class="modal-content">
      <div class="flex justify-between items-center mb-6">
        <h3 class="text-2xl font-bold text-[#1f1d79]">Create a New Debate</h3>
        <button id="close-create-modal" class="text-gray-500 hover:text-gray-700">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>
      
      <form id="create-debate-form" class="space-y-4">
        <div>
          <label for="debate-title" class="block text-sm font-medium text-gray-700 mb-1">Title</label>
          <input type="text" id="debate-title" name="title" required class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-[#1f1d79]">
        </div>
        
        <div>
          <label for="debate-description" class="block text-sm font-medium text-gray-700 mb-1">Description</label>
          <textarea id="debate-description" name="description" rows="3" required class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-[#1f1d79]"></textarea>
        </div>
        
        <div>
          <label for="debate-council" class="block text-sm font-medium text-gray-700 mb-1">UN Council</label>
          <select id="debate-council" name="council" required class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-[#1f1d79]">
            <option value="">-- Select Council --</option>
            <option value="UNSC">UN Security Council (UNSC)</option>
            <option value="UNGA">UN General Assembly (UNGA)</option>
            <option value="UNHRC">UN Human Rights Council (UNHRC)</option>
          </select>
        </div>
        
        <div>
          <label for="debate-topic" class="block text-sm font-medium text-gray-700 mb-1">Topic</label>
          <input type="text" id="debate-topic" name="topic" required class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-[#1f1d79]" placeholder="e.g., Climate Change, Nuclear Disarmament, Human Rights">
        </div>
        
        <div class="pt-4">
          <button type="submit" id="submit-debate-btn" class="w-full py-3 gradient-button text-white font-semibold rounded-md">Create Debate</button>
        </div>
      </form>
    </div>
  </div>
  
  <!-- Debate View Modal -->
  <div id="debate-view-modal" class="modal">
    <div class="modal-content max-w-4xl">
      <div class="flex justify-between items-center mb-4">
        <h3 id="debate-view-title" class="text-2xl font-bold text-[#1f1d79]">Debate Title</h3>
        <button id="close-debate-view-modal" class="text-gray-500 hover:text-gray-700">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>
      
      <div class="mb-4">
        <p id="debate-view-description" class="text-gray-600">Debate description goes here.</p>
        <div class="flex items-center mt-2">
          <span class="text-sm text-gray-500">Council:</span>
          <span id="debate-view-council" class="ml-2 text-sm font-medium text-[#1f1d79]">UNSC</span>
        </div>
        <div class="flex items-center mt-1">
          <span class="text-sm text-gray-500">Topic:</span>
          <span id="debate-view-topic" class="ml-2 text-sm font-medium text-[#1f1d79]">Climate Change</span>
        </div>
      </div>
      
      <div class="border-t border-gray-200 pt-4 mb-4">
        <h4 class="text-lg font-semibold mb-2">Participants</h4>
        <div id="debate-view-participants" class="flex flex-wrap gap-2">
          <!-- Participants will be loaded here -->
        </div>
      </div>
      
      <div id="debate-join-section" class="mb-4">
        <button id="join-debate-btn" class="w-full py-3 gradient-button text-white font-semibold rounded-md">Join Debate</button>
      </div>
      
      <div id="debate-chat-section" class="hidden">
        <div class="border-t border-gray-200 pt-4">
          <h4 class="text-lg font-semibold mb-2">Discussion</h4>
          <div id="debate-chat-container" class="chat-container border border-gray-200 rounded-md p-4 mb-4">
            <!-- Chat messages will be loaded here -->
            <div class="text-center text-gray-500 py-4">
              No messages yet. Be the first to contribute to this debate!
            </div>
          </div>
          
          <form id="chat-form" class="flex gap-2">
            <input type="text" id="chat-input" placeholder="Type your message..." class="flex-1 px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-[#1f1d79]">
            <button type="submit" class="px-4 py-2 gradient-button text-white font-semibold rounded-md">Send</button>
          </form>
          
          <div id="ai-assist-section" class="mt-4 hidden">
            <button id="ai-assist-btn" class="w-full py-2 border border-[#1f1d79] text-[#1f1d79] font-medium rounded-md hover:bg-[#1f1d79] hover:text-white transition">
              Ask AI for Assistance
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- AI Assist Modal -->
  <div id="ai-assist-modal" class="modal">
    <div class="modal-content">
      <div class="flex justify-between items-center mb-6">
        <h3 class="text-2xl font-bold text-[#1f1d79]">AI Assistance</h3>
        <button id="close-ai-assist-modal" class="text-gray-500 hover:text-gray-700">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>
      
      <form id="ai-assist-form" class="space-y-4">
        <div>
          <label for="ai-prompt" class="block text-sm font-medium text-gray-700 mb-1">What would you like help with?</label>
          <textarea id="ai-prompt" rows="3" required class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-[#1f1d79]" placeholder="e.g., Help me draft a response about climate change solutions"></textarea>
        </div>
        
        <div class="pt-4">
          <button type="submit" id="submit-ai-prompt-btn" class="w-full py-3 gradient-button text-white font-semibold rounded-md">Get AI Response</button>
        </div>
      </form>
      
      <div id="ai-response-container" class="hidden mt-6 p-4 bg-blue-50 border border-blue-200 rounded-md">
        <h4 class="text-lg font-semibold text-[#1f1d79] mb-2">AI Response</h4>
        <p id="ai-response-text" class="text-gray-700"></p>
        
        <div class="mt-4 flex justify-end">
          <button id="use-ai-response-btn" class="px-4 py-2 gradient-button text-white font-semibold rounded-md">Use This Response</button>
        </div>
      </div>
    </div>
  </div>
  
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Check if user is logged in
      const userToken = localStorage.getItem('userToken');
      const userEmail = localStorage.getItem('userEmail');
      const userName = localStorage.getItem('userName');
      const userUsername = localStorage.getItem('userUsername');
      const userAvatar = localStorage.getItem('userAvatar');
      
      // Set user ID in localStorage for Pusher
      if (userEmail) {
        fetch(`/api/auth/verify`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ email: userEmail })
        })
        .then(res => res.json())
        .then(data => {
          if (data.valid) {
            localStorage.setItem('userId', data.id);
          }
        })
        .catch(error => console.error('Error verifying user:', error));
      }
      
      if (userToken && userEmail) {
        // User is logged in, show signed in UI
        document.getElementById('user-signed-in').classList.remove('hidden');
        document.getElementById('user-not-signed-in').classList.add('hidden');
        document.getElementById('auth-check').classList.add('hidden');
        
        // Set user info
        if (userUsername) {
          document.getElementById('user-name').textContent = userUsername;
        } else if (userName) {
          document.getElementById('user-name').textContent = userName;
        } else {
          document.getElementById('user-name').textContent = userEmail;
        }
        
        if (userAvatar) {
          document.getElementById('user-avatar').src = userAvatar;
        }
        
        // Handle logout
        document.getElementById('logout-btn').addEventListener('click', function(e) {
          e.preventDefault();
          
          // Clear user data from localStorage
          localStorage.removeItem('userToken');
          localStorage.removeItem('userEmail');
          localStorage.removeItem('userName');
          localStorage.removeItem('userUsername');
          localStorage.removeItem('userAvatar');
          localStorage.removeItem('userId');
          
          // Reload the page
          window.location.reload();
        });
      } else {
        // User is not logged in, show sign in UI
        document.getElementById('user-signed-in').classList.add('hidden');
        document.getElementById('user-not-signed-in').classList.remove('hidden');
        document.getElementById('auth-check').classList.remove('hidden');
      }
      
      // Mobile menu toggle
      const mobileMenuButton = document.getElementById('mobile-menu-button');
      const mobileMenu = document.getElementById('mobile-menu');
      
      mobileMenuButton.addEventListener('click', function() {
        mobileMenu.classList.toggle('hidden');
      });
      
      // Load debates
      loadDebates();
      
      // Filter functionality
      document.getElementById('apply-filters-btn').addEventListener('click', function() {
        loadDebates();
      });
      
      // Create debate modal
      const createDebateBtn = document.getElementById('create-debate-btn');
      const createDebateModal = document.getElementById('create-debate-modal');
      const closeCreateModal = document.getElementById('close-create-modal');
      
      createDebateBtn.addEventListener('click', function() {
        if (!userToken || !userEmail) {
          alert('Please sign in to create a debate.');
          window.location.href = 'signin.html';
          return;
        }
        
        createDebateModal.classList.add('active');
      });
      
      closeCreateModal.addEventListener('click', function() {
        createDebateModal.classList.remove('active');
      });
      
      // Create debate form submission
      const createDebateForm = document.getElementById('create-debate-form');
      
      createDebateForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const title = document.getElementById('debate-title').value;
        const description = document.getElementById('debate-description').value;
        const council = document.getElementById('debate-council').value;
        const topic = document.getElementById('debate-topic').value;
        
        if (!title || !description || !council || !topic) {
          alert('Please fill in all fields.');
          return;
        }
        
        // Check for curse words
        if (containsCurseWords(title) || containsCurseWords(description) || containsCurseWords(topic)) {
          alert('Please avoid using inappropriate language in your debate.');
          return;
        }
        
        // Disable submit button
        const submitBtn = document.getElementById('submit-debate-btn');
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<span class="spinner inline-block mr-2"></span> Creating...';
        
        // Create debate
        fetch('/api/debates', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            title,
            description,
            council,
            topic,
            email: userEmail
          })
        })
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            // Close modal
            createDebateModal.classList.remove('active');
            
            // Reset form
            createDebateForm.reset();
            
            // Reload debates
            loadDebates();
            
            // Open the debate view
            openDebateView(data.debate);
          } else {
            alert('Error: ' + (data.error || 'Failed to create debate'));
          }
          
          // Re-enable submit button
          submitBtn.disabled = false;
          submitBtn.innerHTML = 'Create Debate';
        })
        .catch(error => {
          console.error('Error creating debate:', error);
          alert('An error occurred. Please try again later.');
          
          // Re-enable submit button
          submitBtn.disabled = false;
          submitBtn.innerHTML = 'Create Debate';
        });
      });
      
      // Debate view modal
      const debateViewModal = document.getElementById('debate-view-modal');
      const closeDebateViewModal = document.getElementById('close-debate-view-modal');
      
      closeDebateViewModal.addEventListener('click', function() {
        debateViewModal.classList.remove('active');
      });
      
      // AI assist modal
      const aiAssistModal = document.getElementById('ai-assist-modal');
      const closeAiAssistModal = document.getElementById('close-ai-assist-modal');
      
      closeAiAssistModal.addEventListener('click', function() {
        aiAssistModal.classList.remove('active');
      });
      
      // AI assist form submission
      const aiAssistForm = document.getElementById('ai-assist-form');
      
      aiAssistForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const prompt = document.getElementById('ai-prompt').value;
        
        if (!prompt) {
          alert('Please enter a prompt.');
          return;
        }
        
        // Disable submit button
        const submitBtn = document.getElementById('submit-ai-prompt-btn');
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<span class="spinner inline-block mr-2"></span> Generating...';
        
        // Get current debate ID
        const debateId = document.getElementById('debate-view-modal').getAttribute('data-debate-id');
        
        // Get AI response
        fetch(`/api/debates/${debateId}/ai-message`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            prompt,
            email: userEmail
          })
        })
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            // Show AI response
            document.getElementById('ai-response-container').classList.remove('hidden');
            document.getElementById('ai-response-text').textContent = data.message.content;
            
            // Set up "Use This Response" button
            document.getElementById('use-ai-response-btn').onclick = function() {
              document.getElementById('chat-input').value = data.message.content;
              aiAssistModal.classList.remove('active');
            };
          } else {
            alert('Error: ' + (data.error || 'Failed to get AI response'));
          }
          
          // Re-enable submit button
          submitBtn.disabled = false;
          submitBtn.innerHTML = 'Get AI Response';
        })
        .catch(error => {
          console.error('Error getting AI response:', error);
          alert('An error occurred. Please try again later.');
          
          // Re-enable submit button
          submitBtn.disabled = false;
          submitBtn.innerHTML = 'Get AI Response';
        });
      });
      
      // Functions
      function loadDebates() {
        const debatesList = document.getElementById('debates-list');
        
        // Get filter values
        const topicFilter = document.getElementById('topic-filter').value.toLowerCase();
        const statusFilter = document.getElementById('status-filter').value;
        
        // Show loading spinner
        debatesList.innerHTML = `
          <div class="flex justify-center items-center col-span-full py-12">
            <div class="spinner"></div>
          </div>
        `;
        
        // Fetch debates
        fetch('/api/debates')
          .then(res => res.json())
          .then(data => {
            // Filter debates
            let filteredDebates = data.debates;
            
            if (statusFilter !== 'all') {
              filteredDebates = filteredDebates.filter(debate => debate.status === statusFilter);
            }
            
            if (topicFilter) {
              filteredDebates = filteredDebates.filter(debate => 
                debate.title.toLowerCase().includes(topicFilter) || 
                debate.description.toLowerCase().includes(topicFilter) ||
                (debate.topic && debate.topic.toLowerCase().includes(topicFilter))
              );
            }
            
            // Render debates
            if (filteredDebates.length > 0) {
              debatesList.innerHTML = filteredDebates.map(debate => {
                return `
                  <div class="debate-card bg-white rounded-xl shadow-md overflow-hidden">
                    <div class="p-6">
                      <h3 class="text-xl font-bold text-[#1f1d79] mb-2">${debate.title}</h3>
                      <p class="text-gray-600 mb-4">${debate.description}</p>
                      <div class="flex items-center justify-between mb-2">
                        <span class="text-sm font-medium text-[#1f1d79]">${debate.council}</span>
                        <span class="text-sm text-gray-500">${debate.participants.length} participants</span>
                      </div>
                      <div class="mb-4">
                        <span class="text-sm text-gray-500">Topic: ${debate.topic || 'General'}</span>
                      </div>
                      <button class="view-debate-btn w-full py-2 border border-[#1f1d79] text-[#1f1d79] font-medium rounded-md hover:bg-[#1f1d79] hover:text-white transition" data-debate-id="${debate.id}">View Debate</button>
                    </div>
                  </div>
                `;
              }).join('');
              
              // Add event listeners to view debate buttons
              document.querySelectorAll('.view-debate-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                  const debateId = this.getAttribute('data-debate-id');
                  const debate = filteredDebates.find(d => d.id === debateId);
                  
                  if (debate) {
                    openDebateView(debate);
                  }
                });
              });
            } else {
              debatesList.innerHTML = `
                <div class="col-span-full text-center py-12">
                  <p class="text-gray-500 mb-4">No debates found matching your filters.</p>
                  <button id="create-first-debate-btn" class="px-6 py-3 gradient-button text-white font-semibold rounded-md">Create Your First Debate</button>
                </div>
              `;
              
              document.getElementById('create-first-debate-btn').addEventListener('click', function() {
                if (!userToken || !userEmail) {
                  alert('Please sign in to create a debate.');
                  window.location.href = 'signin.html';
                  return;
                }
                
                createDebateModal.classList.add('active');
              });
            }
          })
          .catch(error => {
            console.error('Error loading debates:', error);
            
            debatesList.innerHTML = `
              <div class="col-span-full text-center py-12">
                <p class="text-red-500 mb-4">Error loading debates. Please try again later.</p>
                <button id="retry-load-debates-btn" class="px-6 py-3 border border-[#1f1d79] text-[#1f1d79] font-semibold rounded-md hover:bg-[#1f1d79] hover:text-white transition">Retry</button>
              </div>
            `;
            
            document.getElementById('retry-load-debates-btn').addEventListener('click', loadDebates);
          });
      }
      
      function openDebateView(debate) {
        // Set debate details
        document.getElementById('debate-view-title').textContent = debate.title;
        document.getElementById('debate-view-description').textContent = debate.description;
        document.getElementById('debate-view-council').textContent = debate.council;
        document.getElementById('debate-view-topic').textContent = debate.topic || 'General';
        
        // Set debate ID
        debateViewModal.setAttribute('data-debate-id', debate.id);
        
        // Render participants
        const participantsContainer = document.getElementById('debate-view-participants');
        
        if (debate.participants.length > 0) {
          participantsContainer.innerHTML = debate.participants.map(participant => {
            return `
              <div class="flex items-center space-x-2 bg-gray-100 rounded-full px-3 py-1">
                <img src="${participant.avatar || '/placeholder.svg'}" alt="${participant.name}" class="w-6 h-6 rounded-full">
                <span class="text-sm font-medium">${participant.username || participant.name}</span>
              </div>
            `;
          }).join('');
        } else {
          participantsContainer.innerHTML = `<p class="text-gray-500">No participants yet.</p>`;
        }
        
        // Check if user is already a participant
        const isParticipant = userEmail && debate.participants.some(p => p.email === userEmail);
        
        if (isParticipant) {
          // User is a participant, show chat section
          document.getElementById('debate-join-section').classList.add('hidden');
          document.getElementById('debate-chat-section').classList.remove('hidden');
          
          // Load chat messages
          loadChatMessages(debate.id);
          
          // Set up chat form
          setupChatForm(debate.id);
          
          // Check if user has access to AI features
          checkAIAccess();
        } else {
          // User is not a participant, show join button
          document.getElementById('debate-join-section').classList.remove('hidden');
          document.getElementById('debate-chat-section').classList.add('hidden');
          
          // Set up join button
          const joinDebateBtn = document.getElementById('join-debate-btn');
          
          joinDebateBtn.onclick = function() {
            if (!userToken || !userEmail) {
              alert('Please sign in to join this debate.');
              window.location.href = 'signin.html';
              return;
            }
            
            // Disable button
            joinDebateBtn.disabled = true;
            joinDebateBtn.innerHTML = '<span class="spinner inline-block mr-2"></span> Joining...';
            
            // Join debate
            fetch(`/api/debates/${debate.id}/join`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                email: userEmail
              })
            })
            .then(res => res.json())
            .then(data => {
              if (data.success) {
                // Show chat section
                document.getElementById('debate-join-section').classList.add('hidden');
                document.getElementById('debate-chat-section').classList.remove('hidden');
                
                // Update participants
                debate.participants.push({
                  email: userEmail,
                  name: userName || userEmail,
                  username: userUsername,
                  avatar: userAvatar
                });
                
                // Re-render participants
                participantsContainer.innerHTML = debate.participants.map(participant => {
                  return `
                    <div class="flex items-center space-x-2 bg-gray-100 rounded-full px-3 py-1">
                      <img src="${participant.avatar || '/placeholder.svg'}" alt="${participant.name}" class="w-6 h-6 rounded-full">
                      <span class="text-sm font-medium">${participant.username || participant.name}</span>
                    </div>
                  `;
                }).join('');
                
                // Load chat messages
                loadChatMessages(debate.id);
                
                // Set up chat form
                setupChatForm(debate.id);
                
                // Check if user has access to AI features
                checkAIAccess();
              } else {
                alert('Error: ' + (data.error || 'Failed to join debate'));
                
                // Re-enable button
                joinDebateBtn.disabled = false;
                joinDebateBtn.innerHTML = 'Join Debate';
              }
            })
            .catch(error => {
              console.error('Error joining debate:', error);
              alert('An error occurred. Please try again later.');
              
              // Re-enable button
              joinDebateBtn.disabled = false;
              joinDebateBtn.innerHTML = 'Join Debate';
            });
          };
        }
        
        // Show modal
        debateViewModal.classList.add('active');
      }
      
      function loadChatMessages(debateId) {
        const chatContainer = document.getElementById('debate-chat-container');
        
        // Show loading
        chatContainer.innerHTML = `
          <div class="flex justify-center items-center py-4">
            <div class="spinner"></div>
          </div>
        `;
        
        // Fetch messages
        fetch(`/api/debates/${debateId}/messages`)
          .then(res => res.json())
          .then(data => {
            if (data.messages && data.messages.length > 0) {
              chatContainer.innerHTML = data.messages.map(message => {
                const isCurrentUser = message.email === userEmail;
                const messageClass = isCurrentUser ? 'user' : message.isAI ? 'ai' : 'other';
                
                return `
                  <div class="chat-message ${messageClass}">
                    <div class="flex items-center mb-1">
                      <img src="${message.avatar || '/placeholder.svg'}" alt="${message.name}" class="w-5 h-5 rounded-full mr-2">
                      <span class="text-xs font-medium">${message.username || message.name}</span>
                      ${message.isAI ? '<span class="ml-1 text-xs bg-purple-100 text-purple-800 px-1 rounded">AI</span>' : ''}
                    </div>
                    <p>${message.content}</p>
                  </div>
                `;
              }).join('');
              
              // Scroll to bottom
              chatContainer.scrollTop = chatContainer.scrollHeight;
            } else {
              chatContainer.innerHTML = `
                <div class="text-center text-gray-500 py-4">
                  No messages yet. Be the first to contribute to this debate!
                </div>
              `;
            }
            
            // Set up Pusher for real-time updates
            setupPusher(debateId);
          })
          .catch(error => {
            console.error('Error loading messages:', error);
            chatContainer.innerHTML = `
              <div class="text-center text-red-500 py-4">
                Error loading messages. Please try again later.
              </div>
            `;
          });
      }
      
      function setupChatForm(debateId) {
        const chatForm = document.getElementById('chat-form');
        const chatInput = document.getElementById('chat-input');
        
        chatForm.onsubmit = function(e) {
          e.preventDefault();
          
          const content = chatInput.value.trim();
          
          if (!content) return;
          
          // Check for curse words
          if (containsCurseWords(content)) {
            alert('Please avoid using inappropriate language in your messages.');
            return;
          }
          
          // Clear input
          chatInput.value = '';
          
          // Send message
          fetch(`/api/debates/${debateId}/messages`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              email: userEmail,
              content
            })
          })
          .then(res => res.json())
          .then(data => {
            if (!data.success) {
              alert('Error: ' + (data.error || 'Failed to send message'));
              chatInput.value = content; // Restore input
            }
          })
          .catch(error => {
            console.error('Error sending message:', error);
            alert('An error occurred. Please try again later.');
            chatInput.value = content; // Restore input
          });
        };
      }
      
      function setupPusher(debateId) {
        // Initialize Pusher
        const pusher = new Pusher('6a59bdd1f5df05fd2554', {
          cluster: 'eu',
          encrypted: true
        });
        
        // Subscribe to debate channel
        const channel = pusher.subscribe(`debate-${debateId}`);
        
        // Listen for new messages
        channel.bind('new-message', function(message) {
          const chatContainer = document.getElementById('debate-chat-container');
          const isCurrentUser = message.email === userEmail;
          const messageClass = isCurrentUser ? 'user' : message.isAI ? 'ai' : 'other';
          
          // Clear "no messages" text if it exists
          if (chatContainer.textContent.includes('No messages yet')) {
            chatContainer.innerHTML = '';
          }
          
          // Add new message
          const messageElement = document.createElement('div');
          messageElement.className = `chat-message ${messageClass}`;
          messageElement.innerHTML = `
            <div class="flex items-center mb-1">
              <img src="${message.avatar || '/placeholder.svg'}" alt="${message.name}" class="w-5 h-5 rounded-full mr-2">
              <span class="text-xs font-medium">${message.username || message.name}</span>
              ${message.isAI ? '<span class="ml-1 text-xs bg-purple-100 text-purple-800 px-1 rounded">AI</span>' : ''}
            </div>
            <p>${message.content}</p>
          `;
          
          chatContainer.appendChild(messageElement);
          
          // Scroll to bottom
          chatContainer.scrollTop = chatContainer.scrollHeight;
        });
        
        // Listen for user joined
        channel.bind('user-joined', function(data) {
          // Reload debate to update participants
          const debateId = document.getElementById('debate-view-modal').getAttribute('data-debate-id');
          
          fetch(`/api/debates/${debateId}`)
            .then(res => res.json())
            .then(data => {
              if (data.debate) {
                // Update participants
                const participantsContainer = document.getElementById('debate-view-participants');
                
                participantsContainer.innerHTML = data.debate.participants.map(participant => {
                  return `
                    <div class="flex items-center space-x-2 bg-gray-100 rounded-full px-3 py-1">
                      <img src="${participant.avatar || '/placeholder.svg'}" alt="${participant.name}" class="w-6 h-6 rounded-full">
                      <span class="text-sm font-medium">${participant.username || participant.name}</span>
                    </div>
                  `;
                }).join('');
              }
            })
            .catch(error => console.error('Error updating participants:', error));
        });
      }
      
      function checkAIAccess() {
        if (!userEmail) return;
        
        fetch(`/api/access/verify?email=${encodeURIComponent(userEmail)}&feature=debate-ai`)
          .then(res => res.json())
          .then(data => {
            if (data.hasAccess) {
              document.getElementById('ai-assist-section').classList.remove('hidden');
              
              // Set up AI assist button
              document.getElementById('ai-assist-btn').onclick = function() {
                // Reset AI assist form
                document.getElementById('ai-assist-form').reset();
                document.getElementById('ai-response-container').classList.add('hidden');
                
                // Show AI assist modal
                aiAssistModal.classList.add('active');
              };
            }
          })
          .catch(error => console.error('Error checking AI access:', error));
      }
      
      // Function to check for curse words
      function containsCurseWords(text) {
        // Simple list of curse words to filter
        const curseWords = [
          'fuck', 'shit', 'ass', 'bitch', 'cunt', 'dick', 'pussy', 'cock', 'whore', 'slut',
          'bastard', 'damn', 'hell', 'piss', 'crap', 'nigger', 'faggot', 'retard'
        ];
        
        const lowerText = text.toLowerCase();
        
        return curseWords.some(word => lowerText.includes(word));
      }
    });
  </script>
</body>
</html>
