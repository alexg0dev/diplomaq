<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Live Debates - Diplomaq.lol</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" />
  <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
  <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
  <style>
    :root {
      --primary: #1f1d79;
      --primary-light: #a5bcda;
      --secondary: #ff6309;
      --secondary-light: #ff7c30;
      --accent: #c75495;
      --bg-cream: #fdfbf6;
      --text-dark: #454545;
    }
    
    body {
      font-family: 'Outfit', sans-serif;
      background-color: #f0f4fc;
      color: var(--text-dark);
      overflow-x: hidden;
    }
    
    .gradient-bg {
      background: linear-gradient(135deg, #1f1d79 0%, #005791 100%);
    }
    
    .gradient-text {
      background: linear-gradient(90deg, #1f1d79 0%, #c75495 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    .gradient-button {
      background: linear-gradient(90deg, #ff6309 0%, #ff7c30 100%);
      transition: all 0.3s ease;
    }
    
    .gradient-button:hover {
      background: linear-gradient(90deg, #e86a00 0%, #f16a30 100%);
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(255, 99, 9, 0.2);
    }
    
    /* Navbar glass effect */
    .glass-nav {
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border-bottom: 1px solid rgba(229, 231, 235, 0.5);
    }
    
    /* Card hover effect */
    .debate-card {
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    
    .debate-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 15px 30px rgba(0, 0, 0, 0.1);
    }
    
    /* Chat styles */
    .chat-container {
      height: calc(100vh - 200px);
      display: flex;
      flex-direction: column;
    }
    
    .chat-messages {
      flex-grow: 1;
      overflow-y: auto;
      padding: 1rem;
    }
    
    .message {
      margin-bottom: 1rem;
      padding: 0.75rem 1rem;
      border-radius: 0.5rem;
      max-width: 80%;
    }
    
    .message-mine {
      background-color: #e9f5ff;
      margin-left: auto;
      border-bottom-right-radius: 0;
    }
    
    .message-other {
      background-color: #f0f0f0;
      margin-right: auto;
      border-bottom-left-radius: 0;
    }
    
    .message-ai {
      background-color: #f0f7ff;
      border-left: 3px solid #1f1d79;
    }
    
    .chat-input {
      padding: 1rem;
      border-top: 1px solid #e5e7eb;
    }
    
    /* Council badges */
    .council-badge {
      display: inline-block;
      padding: 0.25rem 0.5rem;
      border-radius: 9999px;
      font-size: 0.75rem;
      font-weight: 500;
    }
    
    .council-unsc {
      background-color: #fee2e2;
      color: #b91c1c;
    }
    
    .council-unga {
      background-color: #e0f2fe;
      color: #0369a1;
    }
    
    .council-unhrc {
      background-color: #dcfce7;
      color: #15803d;
    }
    
    .council-who {
      background-color: #fef3c7;
      color: #92400e;
    }
    
    .council-ecosoc {
      background-color: #e0e7ff;
      color: #4338ca;
    }
    
    .council-unep {
      background-color: #d1fae5;
      color: #047857;
    }
    
    /* Status badges */
    .status-badge {
      display: inline-block;
      padding: 0.25rem 0.5rem;
      border-radius: 9999px;
      font-size: 0.75rem;
      font-weight: 500;
    }
    
    .status-active {
      background-color: #dcfce7;
      color: #15803d;
    }
    
    .status-scheduled {
      background-color: #fef3c7;
      color: #92400e;
    }
    
    .status-completed {
      background-color: #e0e7ff;
      color: #4338ca;
    }
    
    /* Loading spinner */
    .spinner {
      border: 4px solid rgba(0, 0, 0, 0.1);
      width: 36px;
      height: 36px;
      border-radius: 50%;
      border-left-color: var(--primary);
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }
      100% {
        transform: rotate(360deg);
      }
    }
    
    /* Subscription badges */
    .subscription-badge {
      display: inline-block;
      padding: 0.25rem 0.5rem;
      border-radius: 9999px;
      font-size: 0.75rem;
      font-weight: 500;
    }
    
    .subscription-free {
      background-color: #e5e7eb;
      color: #4b5563;
    }
    
    .subscription-pro {
      background-color: #fef3c7;
      color: #92400e;
    }
    
    .subscription-elite {
      background-color: #e0e7ff;
      color: #4338ca;
    }
    
    .subscription-institutional {
      background-color: #f3e8ff;
      color: #7e22ce;
    }
  </style>
</head>
<body>
  <!-- Navigation -->
  <nav class="glass-nav shadow-md sticky top-0 z-50 transition-all duration-300">
    <div class="container mx-auto px-4 py-3">
      <div class="flex justify-between items-center">
        <div class="flex items-center space-x-2">
          <a href="index.html" class="flex items-center">
            <div class="relative">
              <svg width="48" height="48" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
                <circle cx="24" cy="24" r="18" fill="#1f1d79"/>
                <path d="M24 6C14.0589 6 6 14.0589 6 24C6 33.9411 14.0589 42 24 42C33.9411 42 42 33.9411 42 24C42 14.0589 33.9411 6 24 6Z" fill="#1f1d79"/>
                <path d="M18 18C18 16.0117 19.6117 14.4 21.6 14.4H26.4C28.3883 14.4 30 16.0117 30 18V30C30 31.9883 28.3883 33.6 26.4 33.6H21.6C19.6117 33.6 18 31.9883 18 30V18Z" fill="white"/>
                <path d="M14.4 21.6C14.4 20.2745 15.4745 19.2 16.8 19.2C18.1255 19.2 19.2 20.2745 19.2 21.6V26.4C19.2 27.7255 18.1255 28.8 16.8 28.8C15.4745 28.8 14.4 27.7255 14.4 26.4V21.6Z" fill="white"/>
                <path d="M28.8 21.6C28.8 20.2745 29.8745 19.2 31.2 19.2C32.5255 19.2 33.6 20.2745 33.6 21.6V26.4C33.6 27.7255 32.5255 28.8 31.2 28.8C29.8745 28.8 28.8 27.7255 28.8 26.4V21.6Z" fill="white"/>
                <path d="M34 34L38 38M38 34L34 38" stroke="white" stroke-width="1.5" stroke-linecap="round"/>
              </svg>
              <div class="absolute -bottom-1 -right-1 text-xs font-bold text-[#ff6309]">.lol</div>
            </div>
            <h1 class="text-2xl font-bold text-[#1f1d79]">Diplomaq</h1>
          </a>
        </div>
        <div class="hidden md:flex space-x-6">
          <a href="index.html" class="text-gray-600 hover:text-[#1f1d79] transition">Home</a>
          <a href="debates.html" class="text-[#1f1d79] font-medium transition">Debates</a>
          <a href="profile.html" class="text-gray-600 hover:text-[#1f1d79] transition">Profile</a>
          <a href="subscriptions.html" class="text-gray-600 hover:text-[#1f1d79] transition">Subscriptions</a>
        </div>
        <div class="flex items-center">
          <div id="user-info" class="mr-4 hidden">
            <div class="flex items-center">
              <img id="user-avatar" src="/placeholder.svg" alt="User" class="w-8 h-8 rounded-full mr-2">
              <span id="user-name" class="text-sm font-medium"></span>
            </div>
          </div>
          <a href="#" id="logout-btn" class="px-4 py-2 border-2 border-[#1f1d79] text-[#1f1d79] font-medium rounded-md hover:bg-[#1f1d79] hover:text-white transition">Sign Out</a>
        </div>
      </div>
    </div>
  </nav>

  <!-- Main Content -->
  <main class="container mx-auto px-4 py-8">
    <!-- Debates List View -->
    <div id="debates-list-view">
      <div class="flex justify-between items-center mb-8">
        <h1 class="text-3xl font-bold text-[#1f1d79]">Live Debates</h1>
        <button id="create-debate-btn" class="gradient-button text-white px-4 py-2 rounded-md font-medium">Create Debate</button>
      </div>
      
      <div class="mb-6">
        <div class="flex flex-wrap gap-2">
          <button class="filter-btn px-3 py-1 rounded-md bg-[#1f1d79] text-white" data-filter="all">All</button>
          <button class="filter-btn px-3 py-1 rounded-md bg-white text-gray-700 border border-gray-300" data-filter="active">Active</button>
          <button class="filter-btn px-3 py-1 rounded-md bg-white text-gray-700 border border-gray-300" data-filter="scheduled">Scheduled</button>
          <button class="filter-btn px-3 py-1 rounded-md bg-white text-gray-700 border border-gray-300" data-filter="unsc">UNSC</button>
          <button class="filter-btn px-3 py-1 rounded-md bg-white text-gray-700 border border-gray-300" data-filter="unga">UNGA</button>
          <button class="filter-btn px-3 py-1 rounded-md bg-white text-gray-700 border border-gray-300" data-filter="unhrc">UNHRC</button>
          <button class="filter-btn px-3 py-1 rounded-md bg-white text-gray-700 border border-gray-300" data-filter="who">WHO</button>
          <button class="filter-btn px-3 py-1 rounded-md bg-white text-gray-700 border border-gray-300" data-filter="ecosoc">ECOSOC</button>
          <button class="filter-btn px-3 py-1 rounded-md bg-white text-gray-700 border border-gray-300" data-filter="unep">UNEP</button>
        </div>
      </div>
      
      <div id="debates-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        <!-- Debates will be loaded here -->
        <div class="debate-card bg-white rounded-xl shadow-md overflow-hidden">
          <div class="p-6">
            <div class="flex justify-between items-start mb-3">
              <span class="council-badge council-unsc">UNSC</span>
              <span class="status-badge status-active">Active</span>
            </div>
            <h3 class="text-xl font-bold text-[#1f1d79] mb-2">Nuclear Disarmament</h3>
            <p class="text-gray-600 text-sm mb-4">Discussing the path to global nuclear disarmament</p>
            <div class="flex justify-between items-center">
              <div class="text-xs text-gray-500">
                <span>8 participants</span>
              </div>
              <button class="join-debate-btn px-4 py-1.5 gradient-button text-white text-sm font-medium rounded-md" data-id="3">Join Debate</button>
            </div>
          </div>
        </div>
        
        <div class="debate-card bg-white rounded-xl shadow-md overflow-hidden">
          <div class="p-6">
            <div class="flex justify-between items-start mb-3">
              <span class="council-badge council-who">WHO</span>
              <span class="status-badge status-active">Active</span>
            </div>
            <h3 class="text-xl font-bold text-[#1f1d79] mb-2">Global Health Crisis Response</h3>
            <p class="text-gray-600 text-sm mb-4">Strategies for international cooperation during health emergencies</p>
            <div class="flex justify-between items-center">
              <div class="text-xs text-gray-500">
                <span>12 participants</span>
              </div>
              <button class="join-debate-btn px-4 py-1.5 gradient-button text-white text-sm font-medium rounded-md" data-id="2">Join Debate</button>
            </div>
          </div>
        </div>
      </div>
      
      <div id="debates-loading" class="flex justify-center items-center py-12 hidden">
        <div class="spinner"></div>
      </div>
      
      <div id="debates-empty" class="text-center py-12 hidden">
        <p class="text-gray-500">No debates found. Try adjusting your filters or create a new debate.</p>
      </div>
      
      <div class="mt-8">
        <div class="bg-white rounded-xl shadow-md p-6">
          <h2 class="text-xl font-bold text-[#1f1d79] mb-4">Your Debate Limits</h2>
          <div class="flex flex-col md:flex-row md:items-center justify-between">
            <div>
              <p class="text-gray-600 mb-2">Your subscription: <span id="user-subscription" class="font-medium"></span></p>
              <p class="text-gray-600">Debates joined today: <span id="debates-joined-today" class="font-medium">0</span>/<span id="debates-daily-limit" class="font-medium">8</span></p>
            </div>
            <div class="mt-4 md:mt-0">
              <a href="subscriptions.html" class="text-[#1f1d79] hover:underline">Upgrade for more debates</a>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Debate Detail View -->
    <div id="debate-detail-view" class="hidden">
      <div class="flex justify-between items-center mb-6">
        <button id="back-to-debates" class="flex items-center text-[#1f1d79]">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd" />
          </svg>
          Back to Debates
        </button>
        <div>
          <span id="debate-council" class="council-badge mr-2"></span>
          <span id="debate-status" class="status-badge"></span>
        </div>
      </div>
      
      <div class="bg-white rounded-xl shadow-md overflow-hidden mb-6">
        <div class="p-6">
          <h1 id="debate-title" class="text-2xl font-bold text-[#1f1d79] mb-2"></h1>
          <p id="debate-description" class="text-gray-600 mb-4"></p>
          
          <div class="flex flex-wrap gap-2 mb-4">
            <div class="flex items-center">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-500 mr-1" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd" />
              </svg>
              <span id="debate-time" class="text-sm text-gray-500"></span>
            </div>
            <div class="flex items-center">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-500 mr-1" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd" />
              </svg>
              <span id="debate-participants-count" class="text-sm text-gray-500">0 participants</span>
            </div>
          </div>
          
          <div id="debate-join-section" class="hidden">
            <button id="join-debate-action" class="gradient-button text-white px-4 py-2 rounded-md font-medium">Join This Debate</button>
          </div>
        </div>
      </div>
      
      <div id="debate-chat-section" class="hidden">
        <div class="bg-white rounded-xl shadow-md overflow-hidden">
          <div class="chat-container">
            <div id="chat-messages" class="chat-messages">
              <!-- Messages will be loaded here -->
            </div>
            
            <div class="chat-input">
              <form id="message-form" class="flex">
                <input type="text" id="message-input" class="flex-grow px-4 py-2 border border-gray-300 rounded-l-md focus:outline-none focus:ring-2 focus:ring-[#1f1d79]" placeholder="Type your message...">
                <button type="submit" class="gradient-button text-white px-4 py-2 rounded-r-md">Send</button>
              </form>
              
              <div id="ai-help-section" class="mt-4 hidden">
                <button id="ai-help-btn" class="w-full flex items-center justify-center px-4 py-2 border border-[#1f1d79] text-[#1f1d79] rounded-md hover:bg-[#1f1d79] hover:text-white transition">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-8.707l-3-3a1 1 0 00-1.414 0l-3 3a1 1 0 001.414 1.414L9 9.414V13a1 1 0 102 0V9.414l1.293 1.293a1 1 0 001.414-1.414z" clip-rule="evenodd" />
                  </svg>
                  Get AI Assistance
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Create Debate Modal -->
    <div id="create-debate-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
      <div class="bg-white rounded-xl shadow-lg p-6 w-full max-w-md">
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-2xl font-bold text-[#1f1d79]">Create New Debate</h2>
          <button id="close-modal" class="text-gray-500 hover:text-gray-700">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
        </div>
        
        <form id="create-debate-form" class="space-y-4">
          <div>
            <label for="debate-title-input" class="block text-sm font-medium text-gray-700 mb-1">Title</label>
            <input type="text" id="debate-title-input" name="title" required class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-[#1f1d79]">
          </div>
          
          <div>
            <label for="debate-description-input" class="block text-sm font-medium text-gray-700 mb-1">Description</label>
            <textarea id="debate-description-input" name="description" rows="3" required class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-[#1f1d79]"></textarea>
          </div>
          
          <div>
            <label for="debate-council-input" class="block text-sm font-medium text-gray-700 mb-1">Council</label>
            <select id="debate-council-input" name="council" required class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-[#1f1d79]">
              <option value="">Select Council</option>
              <option value="UNSC">UN Security Council</option>
              <option value="UNGA">UN General Assembly</option>
              <option value="UNHRC">UN Human Rights Council</option>
              <option value="WHO">World Health Organization</option>
              <option value="ECOSOC">Economic and Social Council</option>
              <option value="UNEP">UN Environment Programme</option>
            </select>
          </div>
          
          <div class="pt-4">
            <button type="submit" class="w-full gradient-button text-white py-2 rounded-md font-medium">Create Debate</button>
          </div>
        </form>
      </div>
    </div>
  </main>

  <!-- Footer -->
  <footer class="bg-[#1f1d79] text-white py-8 px-4 mt-12">
    <div class="container mx-auto max-w-6xl">
      <div class="text-center">
        <p class="text-sm text-gray-300">&copy; 2023 Diplomaq.lol. All rights reserved.</p>
      </div>
    </div>
  </footer>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Initialize AOS
      AOS.init({
        duration: 800,
        easing: 'ease-in-out',
        once: true
      });
      
      // Check if user is logged in
      const userToken = localStorage.getItem('userToken');
      const userEmail = localStorage.getItem('userEmail');
      
      if (!userToken || !userEmail) {
        window.location.href = 'signin.html';
        return;
      }
      
      // Display user info
      const userInfo = document.getElementById('user-info');
      const userName = document.getElementById('user-name');
      const userAvatar = document.getElementById('user-avatar');
      
      if (userInfo && userName && userAvatar) {
        userInfo.classList.remove('hidden');
        userName.textContent = localStorage.getItem('userName') || userEmail;
        
        const avatar = localStorage.getItem('userAvatar');
        if (avatar) {
          userAvatar.src = avatar;
        }
      }
      
      // Set user subscription info
      const userSubscription = document.getElementById('user-subscription');
      const subscription = localStorage.getItem('userSubscription') || 'free';
      
      if (userSubscription) {
        userSubscription.textContent = subscription.charAt(0).toUpperCase() + subscription.slice(1);
        userSubscription.className = `subscription-badge subscription-${subscription}`;
      }
      
      // Set debate limits based on subscription
      const debatesDailyLimit = document.getElementById('debates-daily-limit');
      let dailyLimit = 8;
      
      if (subscription === 'pro') {
        dailyLimit = 20;
      } else if (subscription === 'elite') {
        dailyLimit = 50;
      } else if (subscription === 'institutional') {
        dailyLimit = 100;
      }
      
      if (debatesDailyLimit) {
        debatesDailyLimit.textContent = dailyLimit;
      }
      
      // Fetch user profile to get debates joined today
      fetch(`/api/user/profile?email=${encodeURIComponent(userEmail)}`)
        .then(res => res.json())
        .then(data => {
          const debatesJoinedToday = document.getElementById('debates-joined-today');
          if (debatesJoinedToday) {
            debatesJoinedToday.textContent = data.debatesJoinedToday || 0;
          }
        })
        .catch(error => {
          console.error('Error fetching user profile:', error);
        });
      
      // Load debates
      loadDebates();
      
      // Filter buttons
      const filterButtons = document.querySelectorAll('.filter-btn');
      filterButtons.forEach(button => {
        button.addEventListener('click', function() {
          // Update active state
          filterButtons.forEach(btn => {
            btn.classList.remove('bg-[#1f1d79]', 'text-white');
            btn.classList.add('bg-white', 'text-gray-700', 'border', 'border-gray-300');
          });
          
          this.classList.remove('bg-white', 'text-gray-700', 'border', 'border-gray-300');
          this.classList.add('bg-[#1f1d79]', 'text-white');
          
          // Apply filter
          const filter = this.getAttribute('data-filter');
          loadDebates(filter);
        });
      });
      
      // Create debate button
      const createDebateBtn = document.getElementById('create-debate-btn');
      const createDebateModal = document.getElementById('create-debate-modal');
      const closeModalBtn = document.getElementById('close-modal');
      
      if (createDebateBtn && createDebateModal && closeModalBtn) {
        createDebateBtn.addEventListener('click', function() {
          createDebateModal.classList.remove('hidden');
        });
        
        closeModalBtn.addEventListener('click', function() {
          createDebateModal.classList.add('hidden');
        });
        
        // Close modal when clicking outside
        createDebateModal.addEventListener('click', function(e) {
          if (e.target === createDebateModal) {
            createDebateModal.classList.add('hidden');
          }
        });
      }
      
      // Create debate form
      const createDebateForm = document.getElementById('create-debate-form');
      if (createDebateForm) {
        createDebateForm.addEventListener('submit', function(e) {
          e.preventDefault();
          
          const title = document.getElementById('debate-title-input').value;
          const description = document.getElementById('debate-description-input').value;
          const council = document.getElementById('debate-council-input').value;
          
          fetch('/api/debates', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${userToken}`
            },
            body: JSON.stringify({
              title,
              description,
              council,
              email: userEmail
            })
          })
          .then(res => res.json())
          .then(data => {
            if (data.success) {
              createDebateModal.classList.add('hidden');
              loadDebates();
              showDebateDetail(data.debate.id);
            } else {
              alert('Error: ' + (data.error || 'Failed to create debate'));
            }
          })
          .catch(error => {
            console.error('Error creating debate:', error);
            alert('An error occurred. Please try again later.');
          });
        });
      }
      
      // Back to debates button
      const backToDebatesBtn = document.getElementById('back-to-debates');
      if (backToDebatesBtn) {
        backToDebatesBtn.addEventListener('click', function() {
          document.getElementById('debates-list-view').classList.remove('hidden');
          document.getElementById('debate-detail-view').classList.add('hidden');
        });
      }
      
      // Join debate action
      document.addEventListener('click', function(e) {
        if (e.target.classList.contains('join-debate-btn')) {
          const debateId = e.target.getAttribute('data-id');
          joinDebate(debateId);
        }
      });
      
      const joinDebateActionBtn = document.getElementById('join-debate-action');
      if (joinDebateActionBtn) {
        joinDebateActionBtn.addEventListener('click', function() {
          const debateId = this.getAttribute('data-debate-id');
          joinDebate(debateId);
        });
      }
      
      // Message form
      const messageForm = document.getElementById('message-form');
      if (messageForm) {
        messageForm.addEventListener('submit', function(e) {
          e.preventDefault();
          
          const messageInput = document.getElementById('message-input');
          const content = messageInput.value.trim();
          
          if (!content) return;
          
          const debateId = document.querySelector('#join-debate-action').getAttribute('data-debate-id');
          
          fetch(`/api/debates/${debateId}/messages`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${userToken}`
            },
            body: JSON.stringify({
              content,
              email: userEmail
            })
          })
          .then(res => res.json())
          .then(data => {
            if (data.success) {
              messageInput.value = '';
              addMessageToChat(data.message);
              scrollToBottom();
            } else {
              alert('Error: ' + (data.error || 'Failed to send message'));
            }
          })
          .catch(error => {
            console.error('Error sending message:', error);
            alert('An error occurred. Please try again later.');
          });
        });
      }
      
      // AI help button
      const aiHelpBtn = document.getElementById('ai-help-btn');
      if (aiHelpBtn) {
        aiHelpBtn.addEventListener('click', function() {
          const debateId = document.querySelector('#join-debate-action').getAttribute('data-debate-id');
          
          // Get the last few messages for context
          const chatMessages = document.getElementById('chat-messages');
          const lastMessages = Array.from(chatMessages.querySelectorAll('.message')).slice(-3);
          let context = lastMessages.map(msg => {
            const name = msg.querySelector('.message-name').textContent;
            const content = msg.querySelector('.message-content').textContent;
            return `${name}: ${content}`;
          }).join('\n');
          
          if (!context) {
            context = "This debate has just started.";
          }
          
          const prompt = `Based on the following conversation in a diplomatic debate, provide a thoughtful response:\n\n${context}`;
          
          fetch(`/api/debates/${debateId}/ai-message`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${userToken}`
            },
            body: JSON.stringify({
              prompt,
              email: userEmail
            })
          })
          .then(res => res.json())
          .then(data => {
            if (data.success) {
              addMessageToChat(data.message);
              scrollToBottom();
            } else {
              if (data.error && data.error.includes('AI features are only available')) {
                alert('AI assistance is only available to Pro, Elite, and Institutional subscribers. Please upgrade your subscription to use this feature.');
              } else {
                alert('Error: ' + (data.error || 'Failed to get AI assistance'));
              }
            }
          })
          .catch(error => {
            console.error('Error getting AI assistance:', error);
            alert('An error occurred. Please try again later.');
          });
        });
      }
      
      // Logout functionality
      document.getElementById('logout-btn').addEventListener('click', function(e) {
        e.preventDefault();
        
        // Clear local storage
        localStorage.removeItem('userToken');
        localStorage.removeItem('userEmail');
        localStorage.removeItem('userName');
        localStorage.removeItem('userAvatar');
        localStorage.removeItem('userUsername');
        localStorage.removeItem('userSubscription');
        localStorage.removeItem('userSubscriptionExpiry');
        
        // Redirect to signin
        window.location.href = 'signin.html';
      });
      
      // Function to load debates
      function loadDebates(filter = 'all') {
        const debatesContainer = document.getElementById('debates-container');
        const debatesLoading = document.getElementById('debates-loading');
        const debatesEmpty = document.getElementById('debates-empty');
        
        if (!debatesContainer || !debatesLoading || !debatesEmpty) return;
        
        // Show loading
        debatesContainer.innerHTML = '';
        debatesLoading.classList.remove('hidden');
        debatesEmpty.classList.add('hidden');
        
        // Determine API endpoint based on filter
        let endpoint = '/api/debates';
        if (filter === 'active' || filter === 'scheduled') {
          endpoint += `?status=${filter}`;
        }
        
        fetch(endpoint)
          .then(res => res.json())
          .then(data => {
            debatesLoading.classList.add('hidden');
            
            let debates = data.debates || [];
            
            // Apply council filter if needed
            if (['unsc', 'unga', 'unhrc', 'who', 'ecosoc', 'unep'].includes(filter)) {
              debates = debates.filter(debate => debate.council.toLowerCase() === filter.toUpperCase());
            }
            
            if (debates.length === 0) {
              debatesEmpty.classList.remove('hidden');
              return;
            }
            
            // Render debates
            debates.forEach(debate => {
              const debateCard = document.createElement('div');
              debateCard.className = 'debate-card bg-white rounded-xl shadow-md overflow-hidden';
              
              const councilClass = `council-${debate.council.toLowerCase()}`;
              const statusClass = `status-${debate.status.toLowerCase()}`;
              
              debateCard.innerHTML = `
                <div class="p-6">
                  <div class="flex justify-between items-start mb-3">
                    <span class="council-badge ${councilClass}">${debate.council}</span>
                    <span class="status-badge ${statusClass}">${debate.status.charAt(0).toUpperCase() + debate.status.slice(1)}</span>
                  </div>
                  <h3 class="text-xl font-bold text-[#1f1d79] mb-2">${debate.title}</h3>
                  <p class="text-gray-600 text-sm mb-4">${debate.description}</p>
                  <div class="flex justify-between items-center">
                    <div class="text-xs text-gray-500">
                      <span>${debate.participants.length} participants</span>
                    </div>
                    <button class="join-debate-btn px-4 py-1.5 gradient-button text-white text-sm font-medium rounded-md" data-id="${debate.id}">
                      ${debate.status === 'active' ? 'Join Debate' : 'View Details'}
                    </button>
                  </div>
                </div>
              `;
              
              debatesContainer.appendChild(debateCard);
            });
          })
          .catch(error => {
            console.error('Error loading debates:', error);
            debatesLoading.classList.add('hidden');
            debatesEmpty.classList.remove('hidden');
            debatesEmpty.innerHTML = '<p class="text-gray-500">Error loading debates. Please try again later.</p>';
          });
      }
      
      // Function to show debate detail
      function showDebateDetail(debateId) {
        const debatesListView = document.getElementById('debates-list-view');
        const debateDetailView = document.getElementById('debate-detail-view');
        const debateTitle = document.getElementById('debate-title');
        const debateDescription = document.getElementById('debate-description');
        const debateCouncil = document.getElementById('debate-council');
        const debateStatus = document.getElementById('debate-status');
        const debateTime = document.getElementById('debate-time');
        const debateParticipantsCount = document.getElementById('debate-participants-count');
        const debateJoinSection = document.getElementById('debate-join-section');
        const debateChatSection = document.getElementById('debate-chat-section');
        const joinDebateAction = document.getElementById('join-debate-action');
        
        if (!debateDetailView || !debateTitle || !debateDescription) return;
        
        // Show loading state
        debateTitle.textContent = 'Loading...';
        debateDescription.textContent = '';
        
        fetch(`/api/debates/${debateId}`)
          .then(res => res.json())
          .then(data => {
            const debate = data.debate;
            
            if (!debate) {
              alert('Debate not found');
              return;
            }
            
            // Set debate details
            debateTitle.textContent = debate.title;
            debateDescription.textContent = debate.description;
            
            const councilClass = `council-${debate.council.toLowerCase()}`;
            debateCouncil.className = `council-badge ${councilClass}`;
            debateCouncil.textContent = debate.council;
            
            const statusClass = `status-${debate.status.toLowerCase()}`;
            debateStatus.className = `status-badge ${statusClass}`;
            debateStatus.textContent = debate.status.charAt(0).toUpperCase() + debate.status.slice(1);
            
            // Format date
            const startTime = new Date(debate.startTime);
            debateTime.textContent = startTime.toLocaleString();
            
            // Set participants count
            debateParticipantsCount.textContent = `${debate.participants.length} participants`;
            
            // Check if user is already a participant
            const isParticipant = debate.participants.some(p => p.email === userEmail);
            
            if (isParticipant) {
              debateJoinSection.classList.add('hidden');
              debateChatSection.classList.remove('hidden');
              loadMessages(debateId);
              
              // Check if user has access to AI features
              const subscription = localStorage.getItem('userSubscription') || 'free';
              const aiHelpSection = document.getElementById('ai-help-section');
              
              if (subscription !== 'free' && aiHelpSection) {
                aiHelpSection.classList.remove('hidden');
              }
            } else {
              debateJoinSection.classList.remove('hidden');
              debateChatSection.classList.add('hidden');
              
              if (joinDebateAction) {
                joinDebateAction.setAttribute('data-debate-id', debateId);
              }
            }
            
            // Switch to detail view
            debatesListView.classList.add('hidden');
            debateDetailView.classList.remove('hidden');
          })
          .catch(error => {
            console.error('Error loading debate details:', error);
            alert('Error loading debate details. Please try again later.');
          });
      }
      
      // Function to join a debate
      function joinDebate(debateId) {
        fetch(`/api/debates/${debateId}/join`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${userToken}`
          },
          body: JSON.stringify({
            email: userEmail
          })
        })
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            // Update debates joined today count
            const debatesJoinedToday = document.getElementById('debates-joined-today');
            if (debatesJoinedToday) {
              debatesJoinedToday.textContent = data.debatesJoinedToday || 0;
            }
            
            // Show debate detail
            showDebateDetail(debateId);
          } else {
            if (data.error && data.error.includes('Daily debate limit reached')) {
              alert(`You've reached your daily debate limit (${data.limit}). Please upgrade your subscription for more debates.`);
            } else {
              alert('Error: ' + (data.error || 'Failed to join debate'));
            }
          }
        })
        .catch(error => {
          console.error('Error joining debate:', error);
          alert('An error occurred. Please try again later.');
        });
      }
      
      // Function to load messages
      function loadMessages(debateId) {
        const chatMessages = document.getElementById('chat-messages');
        
        if (!chatMessages) return;
        
        // Clear existing messages
        chatMessages.innerHTML = '';
        
        fetch(`/api/debates/${debateId}/messages`)
          .then(res => res.json())
          .then(data => {
            const messages = data.messages || [];
            
            if (messages.length === 0) {
              chatMessages.innerHTML = '<div class="text-center text-gray-500 py-4">No messages yet. Be the first to send a message!</div>';
              return;
            }
            
            // Render messages
            messages.forEach(message => {
              addMessageToChat(message);
            });
            
            // Scroll to bottom
            scrollToBottom();
          })
          .catch(error => {
            console.error('Error loading messages:', error);
            chatMessages.innerHTML = '<div class="text-center text-gray-500 py-4">Error loading messages. Please try again later.</div>';
          });
      }
      
      // Function to add a message to the chat
      function addMessageToChat(message) {
        const chatMessages = document.getElementById('chat-messages');
        
        if (!chatMessages) return;
        
        const messageElement = document.createElement('div');
        
        if (message.isAI) {
          messageElement.className = 'message message-ai';
        } else if (message.email === userEmail) {
          messageElement.className = 'message message-mine';
        } else {
          messageElement.className = 'message message-other';
        }
        
        // Format timestamp
        const timestamp = new Date(message.timestamp);
        const formattedTime = timestamp.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        
        messageElement.innerHTML = `
          <div class="flex items-start">
            <img src="${message.avatar || '/placeholder.svg'}" alt="${message.name}" class="w-8 h-8 rounded-full mr-2">
            <div>
              <div class="flex items-center">
                <span class="message-name font-medium">${message.name}</span>
                <span class="text-xs text-gray-500 ml-2">${formattedTime}</span>
              </div>
              <p class="message-content">${message.content}</p>
            </div>
          </div>
        `;
        
        chatMessages.appendChild(messageElement);
      }
      
      // Function to scroll chat to bottom
      function scrollToBottom() {
        const chatMessages = document.getElementById('chat-messages');
        
        if (chatMessages) {
          chatMessages.scrollTop = chatMessages.scrollHeight;
        }
      }
      
      // Check URL parameters for debate ID
      const urlParams = new URLSearchParams(window.location.search);
      const debateId = urlParams.get('debate');
      
      if (debateId) {
        showDebateDetail(debateId);
      }
    });
  </script>
</body>
</html>
